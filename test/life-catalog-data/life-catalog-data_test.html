<!doctype html>

<html>
  <head>
    <title>life-catalog-data test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../src/life-catalog-data/life-catalog-data.html">

    <link rel="import" href="../../bower_components/iron-test-helpers/iron-test-helpers.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <life-catalog-data></life-catalog-data>
      </template>
    </test-fixture>

    <script>
      suite('life-catalog', () => {
        let element;
        let catalog;
        let server;
        var responseHeaders = {
          json: { 'Content-Type': 'application/json' }
        };

        setup(() => {
          element = fixture('basic');
          catalog =
            [{
              id: 'pencil',
              name: 'Pencil',
              payload: ["1"],
              meta: {
                x: 1,
                y: 1
              }
            },
            {
              id: 'glider',
              name: 'Glider',
              payload: [
                "010",
                "001",
                "111"],
              meta: {
                x: 3,
                y: 3
              }
            },
            {
              id: 'light_weight_spaceship',
              name: 'Light Weight Spaceship',
              payload: [
                "01001",
                "10000",
                "10001",
                "11110"
              ],
              meta: {
                x: 5,
                y: 4
              }
            },
            {
              id: 'glider_gun',
              name: 'Glider Gun',
              payload: [
                "000000000000000000000000100000000000",
                "000000000000000000000010100000000000",
                "000000000000110000001100000000000011",
                "000000000001000100001100000000000011",
                "110000000010000010001100000000000000",
                "110000000010001011000010100000000000",
                "000000000010000010000000100000000000",
                "000000000001000100000000000000000000",
                "000000000000110000000000000000000000"
              ],
              meta: {
                x: 36,
                y: 9
              }
            }];
          server = sinon.fakeServer.create();
          server.respondWith(
            'GET',
            /patterns-lite\.json/, [
              200,
              responseHeaders.json,
              JSON.stringify(catalog)
            ]
          );
        });
        teardown(function() {
          server.restore();
        });

        test('instantiating the element works', () => {
          assert.equal(element.is, 'life-catalog-data');
        });

        test('retrieve catalog data from server', (done) => {
          // element.catalog = catalog;
          const ajax = Polymer.dom(element.root).querySelector('iron-ajax');
          const request = ajax.generateRequest();
          server.respond();
          assert.deepEqual(request.response, catalog);

          ajax.addEventListener('response', (event) => {
            setTimeout(() => {
              assert.equal(element._catalogData.length, catalog.length + 4);
              assert.equal(element.catalog.length, catalog.length + 4);
              done();
            }, 3000);
          });
        });

        test('fire catalog-updated event', (done) => {
          // element.catalog = catalog;
          const ajax = Polymer.dom(element.root).querySelector('iron-ajax');
          const request = ajax.generateRequest();
          server.respond();
          assert.deepEqual(request.response, catalog);

          element.addEventListener('catalog-updated', () => {
            done();
          });
        });

        test('toggling star works', () => {
          let e = {
            model: {
              get: function() {
                // do nothing
              },
              set: function() {

              }
            }
          };

          let stub = sinon.stub(e.model, 'get');
          stub.withArgs('item.starred').returns(false);
          stub.withArgs('item.id').returns('light_weight_spaceship');

          let spy = sinon.spy(e.model, 'set');


          element.toggleStar(e);

          assert.isTrue(spy.withArgs('item.starred', true).called);
          assert.deepEqual(element._starredCatalog, ['light_weight_spaceship']);
        });

      });
    </script>
  </body>
</html>
