<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="../cell.html"> -->
<link rel="import" href="../life-canvas-base/life-canvas-base.html">


<dom-module id="life-canvas">
  <template>
    <!-- <canvas width$="[[app.gameManager.CANVAS_SIZE_X]]" height$="[[app.gameManager.CANVAS_SIZE_Y]]" id="canvas">Your browser doesn't support html5 canvas.</canvas> -->
    <life-canvas-base id="canvas" is-playing="{{app.controller.isPlaying}}" refresh-rate="[[app.controller.refreshRate]]" width="[[app.width]]" height="[[app.height]]" cell-size="[[app.cellSize]]" mode="cell" on-game-loop-end="_drawPreview" background="[[app.backgroundImage]]"></life-canvas-base>
  </template>

  <script>
    Polymer({
      is: 'life-canvas',

      properties: {
        // app: Object,
        app: {
          type: Object,
        },
        // main: {
        //   type: Object,
        //   value: {}
        // },
        isDrawing: {
          type: Boolean,
          value: false
        },
        mousePos: {
          type: Object,
          value: {}
        }

      },

      ready: function() {
        // this.initialize();

        this.$.canvas.getCanvas().addEventListener('click', this._plotOnClick(this), false);
        this.$.canvas.getCanvas().addEventListener('mousemove', this._handlePlotSeq(this), false);
        this.$.canvas.getCanvas().addEventListener('mousemove', this._updateMousePos(this), false);
        this.$.canvas.getCanvas().addEventListener('mousedown', this._handlePlotStart(this), false);
        this.$.canvas.getCanvas().addEventListener('mouseup', this._handlePlotEnd(this), false);

        this.app.controller = {};
        this.set('app.controller.isPlaying', true);
        this.set('app.controller.refreshRate', 30);
        this.mousePos.x = -1;
        this.mousePos.y = -1;

        this.set('app.width', 200);
        this.set('app.height', 150);
        this.set('app.cellSize', 4);

        // this.mainLoop();
      },

      _toCellCoordinates: function(e){
        var rect = e.target.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var y = e.clientY - rect.top;

        return [Math.floor(x / this.$.canvas.cellSize), Math.floor(y / this.$.canvas.cellSize)];
      },


      _plotOnClick: function(self){
        return function(e){
          if(!self.app._selectedPattern || Object.keys(self.app._selectedPattern).length === 0 ) return;
          self.injectPattern.apply(self, [...self._toCellCoordinates(e), self.app._selectedPattern.payload]);
          // self._draw();
        };
      },
      _handlePlotStart: function(self){
        return function(e){
          self.isDrawing = true;
        };
      },
      _handlePlotSeq: function(self){
        return function(e){
          if (!self.isDrawing) return;

          self._plotOnClick(self)(e);
        };
      },
      _updateMousePos: function(self){
        return function(e){
          self.mousePos.x = self._toCellCoordinates(e)[0];
          self.mousePos.y = self._toCellCoordinates(e)[1];
        };
      },
      _handlePlotEnd: function(self){
        return function(e){
          self.isDrawing = false;
        };
      },

      _drawPreview: function(){
        // if( !this.app.catalog || !this.app.selected) return;
        if( !this.app._catalog || !this.app._selectedPattern || Object.keys(this.app._selectedPattern).length === 0) return;
        var startX = this.mousePos.x;
        var startY = this.mousePos.y;
        var pattern = this.app._selectedPattern.payload;

        this.$.canvas.injectOverlay(startX, startY, pattern);
      },

      getCanvasDataURL: function(){
        return this.$.canvas.getCanvasDataURL();
      },

      getRLE: function(){
        return this.$.canvas.getRLE();
      },

      initialize: function(){
        this.$.canvas.initialize();
      },

      injectPattern: function(startX, startY, pattern){
        this.$.canvas.injectPattern(startX, startY, pattern, this.app.color);
      },
      clearCanvas: function(){
        this.$.canvas.clearCanvas();
      },

      // setColors: function(){
      //   var gm = this.$.canvas._gameManager;
      //   console.log(gm);
      //   if(this.app._colors.width < gm.CELL_WIDTH || this.app._colors.height < gm.CELL_HEIGHT){
      //     console.log("error!!");
      //     return;
      //   }
      //
      //   for(var i = 0; i < gm.CELL_HEIGHT; i++){
      //     for(var j = 0; j < gm.CELL_WIDTH; j++){
      //       gm.getCellAt(j, i).color = this.app._colors.payload[i][j];
      //       gm.getCellAt(j, i).state = 1;
      //     }
      //   }
      //   gm.draw();
      //
      //   console.log("done!");
      //
      //
      //
      // },

    });
  </script>
</dom-module>
