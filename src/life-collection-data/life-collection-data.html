<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<link rel="import" href="../life-behaviors/life-analytics-behavior.html">

<dom-module id="life-collection-data">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-document
      id="document"
      app-name="life">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="life"
      path="/collections/[[user.uid]]"
      data="{{collections}}">
    </firebase-query>
    <app-indexeddb-mirror
      session="[[user.uid]]"
      key="life"
      data="{{collections}}"
      persisted-data="{{persistedCollections}}">
    </app-indexeddb-mirror>

  </template>
  <script>
    Polymer({
      is: 'life-collection-data',
      behaviors: [LifeAnalyticsBehavior],

      properties: {
        // user: Object,

        collections: {
          type: Array,
          notify: true,
        },

        persistedCollections: {
          type: Array,
          notify: true,
        },
      },

      addCollection: function(collection) {
        // this.push('collections', collection);

        this.$.document.data = collection;
        this.$.document.save(this.collectionsPath).then(() => {
          this.$.document.reset();
        });
      },
      deleteCollection: function(collection) {
        const index = this.collections.indexOf(collection);
        if (index != -1) {
          this.$.document.path = `${this.collectionsPath}/${collection.$key}`;
          this.$.document.destroy();
        } else {
          this.sendException('failed to delete collection');
        }
      },

      get collectionsPath() {
        return '/collections/' + this.user.uid;
      },
    });
  </script>
</dom-module>
