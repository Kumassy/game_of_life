<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">


<link rel="import" href="../life-icon-toggle/life-icon-toggle.html">



<dom-module id="life-app">
  <template>

    <!-- <app-drawer-layout>

      <app-drawer swipe-ope></app-drawer>

      <app-drawer id="endDrawer" align="end" swipe-open></app-drawer>

      <app-toolbar>
        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
        <div main-title></div>
        <paper-icon-button icon="info" onclick="document.getElementById('endDrawer').toggle();"></paper-icon-button>
      </app-toolbar> -->

    <app-drawer-layout force-narrow>
      <app-drawer swipe-ope>
        <app-header fixed>
          <app-toolbar>
            <div main-title>All Patterns</div>
          </app-toolbar>
        </app-header>
        <paper-listbox style="height: 100%; overflow: auto;" on-iron-select="handleItemChange" selected="0">
          <paper-item id="pencil">Pencil</paper-item>
          <paper-item id="glider">Glider</paper-item>
          <paper-item id="light_weight_spaceship">Light Weight Spaceship</paper-item>
          <paper-item id="medium_weight_spaceship">Medium Weight Spaceship</paper-item>
          <paper-item id="heavy_weight_spaceship">Heavy Weight Spaceship</paper-item>
          <paper-item id="glider_gun">Glider Gun</paper-item>

          <template is="dom-repeat" items="{{app.localCatalog}}">
            <paper-item id="{{item.id}}" style="justify-content: space-between;"  on-tap="_handleItemTap">
              {{item.name}}
              <!-- <paper-icon-button icon="star" alt="favourite this!">
              </paper-icon-button> -->

              <!-- TODO: bind with {{}} to life-icon-toggle -->
              <life-icon-toggle pressed="{{item.starred}}"></life-icon-toggle>
            </paper-item>
          </template>
        </paper-listbox>
      </app-drawer>

      <app-drawer id="endDrawer" align="end" swipe-open>
        <paper-tabs id="tabs" selected="{{_tab}}">
          <paper-tab name="starredPatterns">Star</paper-tab>
          <paper-tab name="canvasSaves">Saves</paper-tab>
        </paper-tabs>

        <iron-pages selected="[[_tab]]" class="flex">
          <div id="starredPatterns">
            <paper-listbox style="height: 100%; overflow: auto;" selected="0">
              <template is="dom-repeat" items="{{app.localCatalog}}" filter="_isPatternStarred" observe="starred">
                <paper-item style="justify-content: space-between;">
                  {{item.name}}
                </paper-item>
              </template>
            </paper-listbox>
          </div>
          <div id="canvasSaves">
            <paper-button on-tap="_handleCreateNewSave" style="width: 100%; text-transform: none; justify-content: flex-start; margin-right: 4px;">
              <iron-icon icon="add" item-icon></iron-icon>
              New
            </paper-button>
            <paper-listbox id="savesList" on-iron-select="_handleSelectSaves" selected="{{_selectedSavesIndex}}" style="height: 100%; overflow: auto;">
              <!-- <paper-item>
                <paper-icon-item>
                  <iron-icon icon="add" item-icon></iron-icon>
                  New
                </paper-icon-item>
              </paper-item> -->
              <template is="dom-repeat" items="{{app.saves}}">
                <paper-item id="{{item.name}}" style="justify-content: space-between;">
                  {{item.name}}
                  <div>
                    <!-- <paper-icon-button icon="save" >
                    </paper-icon-button> -->
                    <paper-icon-button icon="info" on-tap="_handleInfoViewForSave">
                    </paper-icon-button>
                    <!-- <paper-icon-button icon="social:share">
                    </paper-icon-button>
                    <paper-icon-button icon="delete">
                    </paper-icon-button> -->
                  </div>
                </paper-item>
                <!-- <paper-icon-item>
                  <paper-item-body>
                    <div>Recipes</div>
                  </paper-item-body>
                  <paper-icon-button icon="save">
                  </paper-icon-button>
                  <paper-icon-button icon="social:share">
                  </paper-icon-button>
                  <paper-icon-button icon="delete">
                  </paper-icon-button>
                </paper-icon-item> -->
              </template>
            </paper-listbox>
          </div>
        </iron-pages>
      </app-drawer>

      <app-header-layout>
        <app-header style="height: 96px;" fixed>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>Game of Life</div>
            <paper-icon-button icon="star" onclick="document.getElementById('endDrawer').toggle();"></paper-icon-button>
          </app-toolbar>
        </app-header>
      </app-header-layout>



      <div style="float: left; padding: 0 8px;">
        <div>
          <paper-dialog id="infoViewDialog">
            <h2>[[_selectingSaveInfo.name]]</h2>
            <p style="overflow-wrap: break-word; max-height: 240px; overflow-y: scroll;">[[_selectingSaveInfo.data]]</p>
            <paper-input label="Share URL" value="[[_selectingSaveShareURL]]"></paper-input>
            <div class="buttons">
              <!-- <paper-button dialog-dismiss>Share via Twitter</paper-button> -->
              <paper-button dialog-confirm autofocus>OK</paper-button>
            </div>
          </paper-dialog>
          <life-canvas app="{{app}}"></life-canvas>

          <nav>
            <paper-button id="togglecontroller" on-tap="handleTap" toggles style="float: left;">Pause</paper-button>
            <paper-slider value="{{app.controller.refreshRate}}" min="20" max="300" editable style="float: left; min-width: 300px;"></paper-slider>
            <!--                    ^ Awesome!! ^ -->
            <paper-button id="clearcontroller" on-tap="handleClear" toggles style="float: left;">Clear</paper-button>
          </nav>
        </div>
        <div style="clear: both;">
          <div>Use arrow key to increase numbers (you can't type number keys), or you'll get a crash. This bug may be fixed sooner or later.</div>
          <paper-input label="Canvas width" value="{{app.gameManager.CANVAS_SIZE_X}}" type="number" max="3000" on-change="handleCanvasResize" on-keydown="handleCanvasResize" disabled style="float:left; width: 45%; max-width: 400px; margin-right: 8px;"></paper-input>
          <paper-input label="Canvas height" value="{{app.gameManager.CANVAS_SIZE_Y}}" type="number" max="3000" on-change="handleCanvasResize" on-keydown="handleCanvasResize" disabled style="float:left; width: 45%; max-width: 400px;"></paper-input>
          <paper-input label="Cell width" value="{{app.gameManager.CELL_LENGTH_X}}" type="number" max="3000" on-change="handleCanvasResize" on-keydown="handleCanvasResize" style="float:left; width: 45%; max-width: 400px; margin-right: 8px;"></paper-input>
          <paper-input label="Cell height" value="{{app.gameManager.CELL_LENGTH_Y}}" type="number" max="3000" on-change="handleCanvasResize" on-keydown="handleCanvasResize" style="float:left; width: 45%; max-width: 400px;"></paper-input>
          <paper-input label="Cell size" value="{{app.gameManager.CELL_SIZE}}" type="number" min="1" max="10" on-change="handleCellResize" on-keydown="handleCellResize" style="float:left; width: 45%; max-width: 400px;"></paper-input>
          <!-- <span>[[app.gameManager.CANVAS_SIZE_X]]</span> -->
        </div>
      </div>

      <!-- <paper-listbox on-iron-select="handleItemChange" selected="0" style="float: left; height: 100vh; overflow-y: scroll;">
        <paper-item id="pencil">Pencil</paper-item>
        <paper-item id="glider">Glider</paper-item>
        <paper-item id="light_weight_spaceship">Light Weight Spaceship</paper-item>
        <paper-item id="medium_weight_spaceship">Medium Weight Spaceship</paper-item>
        <paper-item id="heavy_weight_spaceship">Heavy Weight Spaceship</paper-item>
        <paper-item id="glider_gun">Glider Gun</paper-item>
        <paper-item id="test">Test</paper-item>


        <template is="dom-repeat" items="{{app.localCatalog}}">
          <paper-item id="{{item.id}}">{{item.name}}</paper-item>
        </template>
      </paper-listbox> -->



      <iron-ajax auto url="../../patterns.json" handle-as="json" on-response="handleResponse"></iron-ajax>

      <!-- <template is="dom-repeat" items="{{app.catalog2}}">
        <paper-item id="{{items.name}}">{{items.name}}</paper-item>
      </template> -->
      <!-- <template is="dom-repeat" items="{{app.catalog2}}">
        <div>First name: <span>{{item.name}}</span></div>
      </template> -->
    </app-drawer-layout>
  </template>


  <style>
    app-toolbar {
      /* Toolbar is the main header, so give it some color */
      background-color: #1E88E5;
      font-family: 'Roboto', Helvetica, sans-serif;
      color: white;
      --app-toolbar-font-size: 20px;
    }
    app-header-layout {
      z-index: 10;
    }
    app-drawer {
      z-index: 11;
    }
    paper-tabs {
      --paper-tabs-selection-bar-color: #304ffe;
    }
    paper-tab {
      --paper-tab-ink: #304ffe;
    }
  </style>

  <script>
    Polymer({
      is: 'life-app',

      properties: {
        app: {
          type: Object,
          value: {}
        },
        params: {
          type: Object,
          observer: '_onParamsChanged'
        },
        _tab: {
          type: Number,
          value: 0
        },
        _selectedSavesIndex: {
          type: Number,
          value: 0
        },
        _selectingSaveInfo: {
          type: Object,
          value: {}
        },
        _selectingSaveShareURL: {
          type: String,
          computed: '_computeShareURL(_selectingSaveInfo)'
        }
      },

      ready: function() {
        this.app.catalog = {};
        // this.app.controller = {};

        // this.app.controller.isRunning = true;
        // this.app.controller.refreshRate = 30;

        this.app.catalog.pencil = [
          "1"
        ];
        this.app.catalog.glider = [
          "010",
          "001",
          "111"];
        this.app.catalog.light_weight_spaceship = [
          "01001",
          "10000",
          "10001",
          "11110"];
        this.app.catalog.medium_weight_spaceship = [
          "000100",
          "010001",
          "100000",
          "100001",
          "111110"];
        this.app.catalog.heavy_weight_spaceship = [
          "0001100",
          "0100001",
          "1000000",
          "1000001",
          "1111110"];
        this.app.catalog.glider_gun = [
          "000000000000000000000000100000000000",
          "000000000000000000000010100000000000",
          "000000000000110000001100000000000011",
          "000000000001000100001100000000000011",
          "110000000010000010001100000000000000",
          "110000000010001011000010100000000000",
          "000000000010000010000000100000000000",
          "000000000001000100000000000000000000",
          "000000000000110000000000000000000000"];
        // this.app.catalog.test = "24bo$22bobo$12b2o6b2o12b2o$11bo3bo4b2o12b2o$2o8bo5bo3b2o$2o8bo3bob2o4bobo$10bo5bo7bo$11bo3bo$12b2o!";
        // this.app.catalog.test = "28bo60b$27bobo59b$27bobo18b2o39b$25b3ob2o17b2o39b$24bo64b$25b3ob2o58b$27bob2o58b4$56b2o31b$56b2o31b12$21bo67b$20bobo66b$20bobo66b$18b3ob2o65b$17bo71b$18b3ob2o65b$20bob2o65b3$4bo57b3o24b$3bobo57bo25b$3bobo57bo2bo22b$b3ob2o56bo2bo22b$o63bobo22b$b3ob2o72b2o8b$3bob2o72b2o8b3$63bo        25b$62bobo24b$63bo25b$80bo8b$79bo7b2o$61b4o22b2o$61b2o3bo10bo11b$62bo        4bo9bobo9b$64bob2o10bo10b$65bo23b3$73bobob2o10b$56bo16bobo13b$55b3o17b        o2bo10b$2b2o70bo3bo10b$2b2o51b3o16b4o2b2o7b$56b2ob2o14bo5b2o6b$58bo21b        o8b3$32b3o54b$33bo55b$10b2o21bo2bo52b$10b2o21bo2bo52b$34bobo52b$49b2o        38b$49b2o38b$55bo33b$54b3o32b$33bo19b2ob2o31b$32bobo18bobo33b$33bo19bo        35b3$31b4o54b$31b2o3bo13bo38b$32bo4bo11bobo37b$34bob2o11bo39b$35bo15b        2o36b$52bo36b$49b3o37b$50b2o37b$47bo41b$47b2o40b$47b2o40b$37b2o6b2o42b        $37b2o4b2o44b$43b2obo42b$45b2o42b5$45b2o42b$45b2o!";

        this.app.catalog.test = "2b3o3b3o2b2$o4bobo4bo$o4bobo4bo$o4bobo4bo$2b3o3b3o2b2$2b3o3b3o2b$o4bobo4bo$o4bobo4bo$o4bobo4bo2$2b3o3b3o!";
        // this.app.catalog.test = "11b2o5b4o$9b2ob2o3bo3bo$9b4o8bo$10b2o5bo2bob2$8bo13b$7b2o8b2o3b$6bo9bo2bo2b$7b5o4bo2bo2b$8b4o3b2ob2o2b$11bo4b2o4b4$18b4o$o2bo13bo3bo$4bo16bo$o3bo12bo2bob$b4o!";


        // this.app.saves = [];
        //   {
        //     name: "test",
        //     data: "RLE format",
        //   },
        // ];

        // this.push('app.saves', {
        //   name: "test",
        //   data: "RLE format"
        // });
        this.set('app.saves', []);

      },

      _onParamsChanged: function(newParams){
        // process params
        // console.log(this.params);

        if(this.params.state){
          if(this.params.state === 'playing'){
            this.app.controller.isRunning = true;
            this.$.togglecontroller.textContent = "Pause";
          }
          else if(this.params.state === 'paused'){
            this.app.controller.isRunning = false;
            this.$.togglecontroller.textContent = "Resume";
          }
        }

        if(this.params.data){
          var lifeCanvas = document.querySelector('life-canvas')
          lifeCanvas.clearCanvas();
          lifeCanvas.injectPattern(0, 0, this.params.data);
        }
      },

      handleTap: function(e, detail) {
        // var rect = e.target.getBoundingClientRect();
        // var x = e.clientX - rect.left;
        // var y = e.clientY - rect.top;

        // document.querySelector('life-canvas').injectPattern( 50, 50, this.app.catalog.glider);
        // document.querySelector('life-canvas').injectPattern( 50, 50, this.app.catalog.light_weight_spaceship);
        // document.querySelector('life-canvas').injectPattern( 50, 50, this.app.catalog.heavy_weight_spaceship);



        this.$.togglecontroller.textContent = (this.app.controller.isRunning ?  "Resume" : "Pause");
        this.app.controller.isRunning = !this.app.controller.isRunning;
      },

      handleClear: function(e, datail) {
        document.querySelector('life-canvas').clearCanvas();
      },

      handleItemChange: function(e){
        // console.log("Changed!!!");
        // console.log(e.detail.item.id);
        // console.log(e);

        this.app.selected = e.detail.item.id;
      },

      handleResponse: function(r){
        // console.log(r.detail.response);

        // this.app.catalog = Object.assign(this.app.catalog, r.detail.response)

        this.set('app.localCatalog', r.detail.response);
        // this.catalog2 = r.detail.response;

        r.detail.response.forEach(function(r){
          this.app.catalog[r.id] = r.payload;

        }.bind(this));

        this.app.localCatalog.forEach(function(lc){
          lc.starred = false;
        });
      },

      handleCanvasResize: function(){
        // if(this.app.gameManager.CANVAS_SIZE_X > 3000){
        //   this.app.gameManager.CANVAS_SIZE_X = 3000;
        //   this.notifyPath('app.gameManager.CANVAS_SIZE_X');
        // }
        // if(this.app.gameManager.CANVAS_SIZE_Y > 3000){
        //   this.app.gameManager.CANVAS_SIZE_Y = 3000;
        //   this.notifyPath('app.gameManager.CANVAS_SIZE_Y');
        // }
        if(this.app.controller.isRunning){
          // stop
          this.handleTap();
        }
        document.querySelector('life-canvas').initialize();

      },

      handleCellResize: function(){
        document.querySelector('life-canvas').resizeCanvas();
      },

      _handleCreateNewSave: function(){
        // console.log("handle!");

        var rle = document.querySelector('life-canvas')._encodeRLE();
        // console.log(r);
        // this.app.saves.push({
        //   name: "hogehoge",
        //   data: r
        // });

        var date = new Date();
        var timestamp = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getHours()).slice(-2);
        this.push('app.saves', {
          name: timestamp,
          data: rle
        });
      },

      _handleSelectSaves: function(e){
        // console.log(e);
        // console.log(e.model);
        // console.log(this._selectedSavesIndex);
        // console.log(this.app.saves[this._selectedSavesIndex].data);
      },
      _handleItemTap: function(e){
        console.log(e);
        console.log(e.model);
        // console.log(this.$.domRepeat.modelForElement(e.target));
        console.log(e.model.get('name'));
      },
      _handleInfoViewForSave: function(){
        console.log(this._selectedSavesIndex);
        this._selectingSaveInfo = this.app.saves[this._selectedSavesIndex];
        this.$.endDrawer.toggle();
        this.$.infoViewDialog.open();
      },
      _computeShareURL: function(_selectingSaveInfo){
        return 'http://kumassy.com/life2/?state=paused&data=' + _selectingSaveInfo.data;
      },
      _isPatternStarred: function(item){
        // console.log(item);
        // console.log(item.starred);
        return item.starred;
      }

    });
  </script>
</dom-module>
