<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="life-app">
  <template>
    <canvas width="600" height="600" id="canvas">Your browser doesn't support html5 canvas.</canvas>
    <h2>Hello [[prop1]]</h2>
  </template>

  <script>
    var Cell = function(x, y){
      this.x = x;
      this.y = y;
      this.state = 0; //dead => not colored
      this._state = 0; //cache
    };

    Cell._getCellStateAt = function(x, y){
      if( x < 0 || y < 0 || x >= this.gameManager.CELL_LENGTH || y >= this.gameManager.CELL_LENGTH ){
        return 0;
      }
      return this.gameManager.cells[ x + y * this.gameManager.CELL_LENGTH]._state;
    };
    Cell.getCellAt = function (x, y){
      if( x < 0 || y < 0 || x >= this.gameManager.CELL_LENGTH || y >= this.gameManager.CELL_LENGTH ){
        return null;
      }
      return this.gameManager.cells[ x + y * this.gameManager.CELL_LENGTH];
    };

    Cell.prototype.draw = function(){
      if(this.state){
        Cell.gameManager.context.fillStyle = '#ff0000';
        Cell.gameManager.context.fillRect(this.x * Cell.gameManager.CELL_SIZE, this.y * Cell.gameManager.CELL_SIZE, Cell.gameManager.CELL_SIZE, Cell.gameManager.CELL_SIZE);
      }
    };
    Cell.prototype.update = function(){
      var aliveCount = 0;

      var directions = [[-1, -1], [0, -1], [1, -1],
                        [-1, 0], [1, 0],
                        [-1, 1], [0, 1], [1, 1]];
      directions.forEach(function(d){
        aliveCount += Cell._getCellStateAt(this.x + d[0], this.y + d[1]);
      }.bind(this));

      if(this._state){ //1, alive
        if(aliveCount <= 1 || aliveCount >= 4){
          this.state = 0;
        }
      }
      else{ // 0, dead
        if(aliveCount === 3){
          this.state = 1;
        }
      }
    };

    Polymer({
      is: 'life-app',

      properties: {
        prop1: {
          type: String,
          value: 'life-app',
        },
      },

      gameManager: {},

      ready: function() {
        Cell.gameManager = this.gameManager;

        Cell.gameManager.CANVAS_SIZE = 600;
        Cell.gameManager.CELL_SIZE = 4;
        Cell.gameManager.CELL_LENGTH = Math.floor(Cell.gameManager.CANVAS_SIZE / Cell.gameManager.CELL_SIZE);
        Cell.gameManager.canvas = document.getElementById('canvas');
        Cell.gameManager.context = canvas.getContext('2d');

        Cell.gameManager.cells = new Array(Cell.gameManager.CELL_LENGTH * Cell.gameManager.CELL_LENGTH);


        for(var i=0; i < Cell.gameManager.cells.length; i++){
          Cell.gameManager.cells[i] = new Cell( i % Cell.gameManager.CELL_LENGTH, Math.floor(i / Cell.gameManager.CELL_LENGTH ));
          if( Math.random() > 0.5){
            Cell.gameManager.cells[i].state = 1;
          }
        }

        Cell.getCellAt( 100 + 1, 100 +0 ).state = 1;
        Cell.getCellAt( 100 +2, 100 +1 ).state = 1;
        Cell.getCellAt( 100 +0, 100 +2 ).state = 1;
        Cell.getCellAt( 100 +1, 100 +2 ).state = 1;
        Cell.getCellAt( 100 +2, 100 +2 ).state = 1;





        Cell.gameManager.isDrawing = false;


        function handleClick(e){
          var rect = e.target.getBoundingClientRect();
          x = e.clientX - rect.left;
          y = e.clientY - rect.top;
          Cell.getCellAt(Math.floor(x / Cell.gameManager.CELL_SIZE), Math.floor(y / Cell.gameManager.CELL_SIZE)).state = 1;
        }
        function onMouseMove(e){
          if (!Cell.gameManager.isDrawing) return;
          handleClick(e);
        };
        function onMouseUp(e){
          Cell.gameManager.isDrawing = false;
        };
        function onMouseDown(e){
          Cell.gameManager.isDrawing = true;
        }
        Cell.gameManager.canvas.addEventListener('click', handleClick, false);
        Cell.gameManager.canvas.addEventListener('mousemove', onMouseMove, false);
        Cell.gameManager.canvas.addEventListener('mousedown', onMouseDown, false);
        Cell.gameManager.canvas.addEventListener('mouseup', onMouseUp, false);


        this.mainLoop();
      },

      mainLoop: function(){
        this.gameManager.context.fillStyle = '#eeeeee';
        this.gameManager.context.fillRect(0, 0, this.gameManager.canvas.width, this.gameManager.canvas.height);


        this.gameManager.cells.forEach(function(c){
          c._state = c.state;
          c.draw();
        });
        this.gameManager.cells.forEach(function(c){
          c.update();
        });

        setTimeout(function(){
          this.mainLoop();
        }.bind(this), 30);
      }

    });
  </script>
</dom-module>
