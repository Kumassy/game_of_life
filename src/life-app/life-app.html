<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route-converter.html">


<link rel="import" href="../life-icon-toggle/life-icon-toggle.html">
<link rel="import" href="../life-dialogs/life-save-dialog.html">
<link rel="import" href="../life-dialogs/life-settings-dialog.html">
<link rel="import" href="../life-brush-editor/life-brush-editor.html">
<link rel="import" href="../life-preview-canvas/life-preview-canvas.html">
<link rel="import" href="../life-canvas/life-canvas.html">
<link rel="import" href="../life-input-image/life-input-image.html">
<link rel="import" href="../life-nav/life-nav.html">
<link rel="import" href="../life-patterns/life-patterns.html">

<dom-module id="life-app">
  <template>
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <!-- <app-route-converter
      path="{{path}}"
      query-params="{{queryParams}}"
      route="{{route}}"></app-route-converter> -->
    <app-route
      route="{{route}}"
      query-params="{{queryParams}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>

    <life-nav
      title="PlayGround"
      page="[[page]]"
      collection="{{app.saves}}"></life-nav>

    <iron-pages role="main" selected="[[page]]" attr-for-selected="name" fallback-selection="path-warning">
      <section name="playground">
        <life-canvas
          id="mainCanvas"
          width="{{app.width}}"
          height="{{app.height}}"
          is-playing="{{app.controller.isPlaying}}"
          refresh-rate="{{app.controller.refreshRate}}"
          cell-size="{{app.cellSize}}"
          cell-color="{{app.cellColor}}"
          overlay-color="{{app.overlayColor}}"
          background-color="{{app.backgroundColor}}"
          brush="{{app._selectedPattern}}"></life-canvas>
        <life-brush-editor stamps="[[app._selectedPattern]]" brush="{{app._selectedPattern}}" app="{{app}}"></life-brush-editor>
        <nav>
          <paper-button id="togglecontroller" on-tap="_togglePlaying" toggles style="float: left;">Pause</paper-button>
          <paper-slider value="{{app.controller.refreshRate}}" min="20" max="300" editable style="float: left; min-width: 300px;"></paper-slider>
          <paper-button id="clearcontroller" on-tap="handleClear" toggles style="float: left;">Clear</paper-button>
        </nav>
      </section>

      <life-patterns
        name="catalog"
        route="{{subroute}}"
        app="{{app}}"></life-patterns>
      <!-- invalid top level paths -->
      <life-path-warning name="path-warning"></life-path-warning>
    </iron-pages>

    <life-save-dialog id="infoViewDialog" target="{{app._selectedSave}}" on-title-change="_handleTitleChange"></life-save-dialog>
    <life-settings-dialog id="settingsDialog" app="{{app}}"></life-settings-dialog>

    <iron-ajax auto url="../../patterns-lite.json" handle-as="json" on-response="handleResponse"></iron-ajax>
  </template>


  <style>
    app-toolbar {
      /* Toolbar is the main header, so give it some color */
      background-color: #1E88E5;
      font-family: 'Roboto', Helvetica, sans-serif;
      color: white;
      --app-toolbar-font-size: 20px;
    }
    app-header-layout {
      z-index: 10;
    }
    app-drawer {
      z-index: 11;
    }
    paper-tabs {
      --paper-tabs-selection-bar-color: #304ffe;
    }
    paper-tab {
      --paper-tab-ink: #304ffe;
    }
  </style>

  <script>
    Polymer({
      is: 'life-app',

      properties: {
        app: {
          type: Object,
          value: function() {
            return {
              _catalog: [],
              saves: [],
              controller: {
                isPlaying: true,
                refreshRate: 30,
              },
              width: 200,
              height: 150,
              cellSize: 4,
              cellColor: 'rgb(255, 0, 0)',
              overlayColor: 'rgba(255, 0, 0, 0.3)',
              backgroundColor: 'rgb(238, 238, 238)',
            };
          }
        },
        params: {
          type: Object,
          observer: '_onParamsChanged'
        },
        page: {
          type: String,
          value: 'playground'
        },
        _tab: {
          type: Number,
          value: 0
        },
        _selectedSavesIndex: {
          type: Number,
          value: 0
        },
        _selectingSaveInfo: {
          type: Object,
          notify: true,
          value: {}
        },
        // _selectingSaveShareURL: {
        //   type: String,
        //   computed: '_computeShareURL(_selectingSaveInfo)'
        // }
      },

      observers: [
        '_routePageChanged(routeData.page)',
        '_queryParamsChanged(queryParams)',

      ],
      listeners: {
        'add-collection': '_addCollection',
        'show-collection-detail': '_showCollectionDetail',
        'open-settings-dialog': '_openSettingsDialog'
      },

      ready: function() {
        // this.app._catalog = [];

        // this.push('app.saves', {
        //   name: "test",
        //   data: "RLE format"
        // });

        // this.set('app.saves', []);

      },

      _routePageChanged: function(page) {
        this.page = page;
      },

      _queryParamsChanged: function(params){
        if(params.state){
          if(params.state === 'playing'){
            this._startPlaying();
          }
          else if(params.state === 'paused'){
            this._stopPlaying();
          }
        }

        if(params.data){
          var lifeCanvas = this.$.mainCanvas;
          lifeCanvas.clearCanvas();
          lifeCanvas.injectPattern(0, 0, params.data);
        }
      },

      _addCollection: function() {
        this._handleCreateNewSave();
      },

      _openSettingsDialog: function() {
        this.$.settingsDialog.open();
      },

      _showCollectionDetail: function(event) {
        this.$.infoViewDialog.target = event.detail.collection;

        // this.$.endDrawer.toggle();
        document.getElementById('endDrawer').toggle();
        this.$.infoViewDialog.open();
      },

      _startPlaying: function(){
        this.$.togglecontroller.textContent = "Pause";
        this.set('app.controller.isPlaying', true);
      },
      _stopPlaying: function(){
        this.$.togglecontroller.textContent = "Resume";
        this.set('app.controller.isPlaying', false);
      },
      _isPlaying: function(){
        return this.get('app.controller.isPlaying');
      },
      _togglePlaying: function(){
        this._isPlaying() ? this._stopPlaying() : this._startPlaying();
      },

      handleClear: function(e, datail) {
        // document.querySelector('life-canvas').clearCanvas();
        this.$.mainCanvas.clearCanvas();
      },

      // handleItemChange: function(e){
      //   // console.log("Changed!!!");
      //   // console.log(e.detail.item.id);
      //   // console.log(e);
      //
      //   this.app.selected = e.detail.item.id;
      // },

      handleResponse: function(r){
        // console.log(r.detail.response);

        this.app._catalog = [
          {
            id: 'pencil',
            name: 'Pencil',
            payload: ["1"],
            meta: {
              x: 1,
              y: 1
            }
          },
          {
            id: 'glider',
            name: 'Glider',
            payload: [
              "010",
              "001",
              "111"],
            meta: {
              x: 3,
              y: 3
            }
          },
          {
            id: 'light_weight_spaceship',
            name: 'Light Weight Spaceship',
            payload: [
              "01001",
              "10000",
              "10001",
              "11110"
            ],
            meta: {
              x: 5,
              y: 4
            }
          },
          {
            id: 'glider_gun',
            name: 'Glider Gun',
            payload: [
              "000000000000000000000000100000000000",
              "000000000000000000000010100000000000",
              "000000000000110000001100000000000011",
              "000000000001000100001100000000000011",
              "110000000010000010001100000000000000",
              "110000000010001011000010100000000000",
              "000000000010000010000000100000000000",
              "000000000001000100000000000000000000",
              "000000000000110000000000000000000000"
            ],
            meta: {
              x: 36,
              y: 9
            }
          }
        ].concat(r.detail.response);

        this.app._catalog.forEach(function(c){
          c.starred = false;
        });

        this.notifyPath('app._catalog');

        // this.app._selectedPattern = {};
        // this.app._selectedPattern = this.app._catalog[0];
        this.set('app._selectedPattern', this.app._catalog[0]);
      },

      _handleCreateNewSave: function(){
        var lifeCanvas = this.$.mainCanvas;

        var rle = lifeCanvas.getRLE();
        var dataUrl = lifeCanvas.getCanvasDataURL();

        var date = new Date();
        var timestamp = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getHours()).slice(-2);
        this.push('app.saves', {
          title: timestamp,
          rle: rle,
          dataUrl: dataUrl,
          shareUrl: 'http://kumassy.com/life/?state=paused&data=' + rle,
          createdAt: new Date(),
          updatedAt: new Date(),
        });
      },

      // _handleSelectSaves: function(e){
      _handleSaveListTap: function(e){
        this.app._selectedSave = e.model.get('item');
      },
      _handlePatternListTap: function(e){
        this.set('app._selectedPattern', e.model.get('item'));
      },
      _handleInfoViewForSave: function(e){
        // console.log(this._selectedSavesIndex);
        // this._selectingSaveInfo = this.app.saves[this._selectedSavesIndex];

        this.set('app._selectedSave', e.model.get('item'));
        this.set('app._selectedSaveIndex', e.model.get('index'));

        // this.$.endDrawer.toggle();
        document.getElementById('endDrawer').toggle();
        this.$.infoViewDialog.open();
        // console.log(this.app.saves);
      },
      _handleTitleChange: function(e){
        if(this.app && this.app.hasOwnProperty('_selectedSaveIndex')){
          this.notifyPath(['app', 'saves', this.app._selectedSaveIndex, 'title']);
        }
      },
      // _computeShareURL: function(_selectingSaveInfo){
      //   return 'http://kumassy.com/life2/?state=paused&data=' + _selectingSaveInfo.rle;
      // },
      _isPatternStarred: function(item){
        return item.starred;
      }

    });
  </script>
</dom-module>
